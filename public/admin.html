<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - ØªØ­Ù…ÙŠÙ„ Ø¨Ù„Ø³</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .admin-header h1 {
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .stat-card .number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-card .label {
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .users-table th,
        .users-table td {
            padding: 1rem;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
        }

        .users-table th {
            background: var(--bg-table-header);
            font-weight: 600;
        }

        .users-table tr:hover {
            background: var(--bg-secondary);
        }

        .action-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-family: inherit;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .btn-view {
            background: var(--primary-bg);
            color: var(--primary);
        }

        .btn-view:hover {
            background: var(--primary);
            color: white;
        }

        .btn-ban {
            background: var(--warning-bg);
            color: var(--warning);
        }

        .btn-ban:hover {
            background: var(--warning);
            color: white;
        }

        .btn-delete {
            background: var(--error-bg);
            color: var(--error);
        }

        .btn-delete:hover {
            background: var(--error);
            color: white;
        }

        .badge-banned {
            background: var(--error);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
        }

        .login-required {
            text-align: center;
            padding: 4rem 2rem;
        }

        .login-required h2 {
            margin-bottom: 1rem;
        }

        .history-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .history-modal.hidden {
            display: none;
        }

        .history-content {
            background: var(--bg-card);
            padding: 2rem;
            border-radius: var(--radius-lg);
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
        }

        .history-item img {
            width: 100px;
            height: 56px;
            object-fit: cover;
            border-radius: var(--radius-sm);
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary);
            text-decoration: none;
            margin-bottom: 1rem;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
        }

        .chart-card h3 {
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .chart-card canvas {
            max-height: 300px;
        }
    </style>
</head>

<body>
    <div class="admin-container">
        <!-- Login Required Screen -->
        <div id="loginRequired" class="login-required">
            <h2>ğŸ”’ Ù…Ø·Ù„ÙˆØ¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <p>ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©</p>
            <button onclick="location.href='/'" class="btn-primary" style="margin-top: 1rem;">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="hidden">
            <a href="/" class="back-link">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>

            <div class="admin-header">
                <h1>ğŸ›¡ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
                <button onclick="loadUsers()" class="btn-secondary">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
            </div>

            <div class="admin-stats">
                <div class="stat-card">
                    <div class="number" id="totalUsers">0</div>
                    <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="activeUsers">0</div>
                    <div class="label">Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù†Ø´Ø·ÙŠÙ†</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="bannedUsers">0</div>
                    <div class="label">Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
                <div class="chart-card">
                    <h3>ğŸ“ˆ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</h3>
                    <canvas id="downloadsChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>ğŸŒ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù…Ø§Ù‹</h3>
                    <canvas id="sourcesChart"></canvas>
                </div>
            </div>

            <h2 style="margin-bottom: 1rem;">ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
            <table class="users-table">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                        <th>Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr>
                        <td colspan="5" style="text-align: center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="history-modal hidden">
        <div class="history-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 id="historyTitle">Ø³Ø¬Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª</h3>
                <button onclick="closeHistoryModal()"
                    style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">âœ•</button>
            </div>
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        // Supabase Config
        const SUPABASE_URL = 'https://vyiqmihfbhsmaokpqgcv.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_2_Up4_GSTc5irBQHSFJY7Q_4W0bp5DS';
        const ADMIN_EMAIL = 'gg9974347@gmail.com';

        let supabaseClient = null;
        try {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (e) {
            console.error('Supabase init failed:', e);
        }

        let accessToken = null;

        // Check admin session
        async function checkAdmin() {
            if (!supabaseClient) {
                console.error('Supabase not available');
                return;
            }

            const { data: { session } } = await supabaseClient.auth.getSession();

            if (!session || session.user.email !== ADMIN_EMAIL) {
                document.getElementById('loginRequired').classList.remove('hidden');
                document.getElementById('adminDashboard').classList.add('hidden');
                return;
            }

            accessToken = session.access_token;
            document.getElementById('loginRequired').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
            loadUsers();
        }

        // Load users
        async function loadUsers() {
            try {
                const res = await fetch('/api/admin/users', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error);
                }

                const data = await res.json();
                renderUsers(data.users);

                // Update stats
                document.getElementById('totalUsers').textContent = data.total;
                document.getElementById('activeUsers').textContent = data.users.filter(u => !u.banned).length;
                document.getElementById('bannedUsers').textContent = data.users.filter(u => u.banned).length;

            } catch (e) {
                alert('Ø®Ø·Ø£: ' + e.message);
            }
        }

        // Render users table
        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');

            if (!users.length) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.email} ${user.email === ADMIN_EMAIL ? 'ğŸ‘‘' : ''}</td>
                    <td>${new Date(user.created_at).toLocaleDateString('ar')}</td>
                    <td>${user.last_sign_in ? new Date(user.last_sign_in).toLocaleDateString('ar') : 'Ù„Ù… ÙŠØ³Ø¬Ù„ Ø¨Ø¹Ø¯'}</td>
                    <td>${user.banned ? '<span class="badge-banned">Ù…Ø­Ø¸ÙˆØ±</span>' : 'âœ… Ù†Ø´Ø·'}</td>
                    <td>
                        ${user.email !== ADMIN_EMAIL ? `
                            <button class="action-btn btn-view" onclick="viewHistory('${user.id}', '${user.email}')">ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„</button>
                            <button class="action-btn btn-ban" onclick="banUser('${user.id}')">ğŸš« Ø­Ø¸Ø±</button>
                            <button class="action-btn btn-delete" onclick="deleteUser('${user.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                        ` : '<em>Ø£Ù†Øª Ø§Ù„Ù…Ø¯ÙŠØ±</em>'}
                    </td>
                </tr>
            `).join('');
        }

        // View user history
        async function viewHistory(userId, email) {
            try {
                const res = await fetch(`/api/admin/history/${userId}`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (!res.ok) throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„');

                const data = await res.json();

                document.getElementById('historyTitle').textContent = `Ø³Ø¬Ù„ ØªØ­Ù…ÙŠÙ„Ø§Øª: ${email}`;
                document.getElementById('historyList').innerHTML = data.history.length ?
                    data.history.map(item => `
                        <div class="history-item">
                            <img src="${item.thumbnail || ''}" alt="${item.title}" onerror="this.style.display='none'">
                            <div>
                                <strong>${item.title || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</strong>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">
                                    ${item.format || 'MP4'} â€¢ ${new Date(item.created_at).toLocaleDateString('ar')}
                                </div>
                            </div>
                        </div>
                    `).join('') :
                    '<p style="text-align: center; padding: 2rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­Ù…ÙŠÙ„Ø§Øª</p>';

                document.getElementById('historyModal').classList.remove('hidden');
            } catch (e) {
                alert('Ø®Ø·Ø£: ' + e.message);
            }
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').classList.add('hidden');
        }

        // Ban user
        async function banUser(userId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) return;

            try {
                const res = await fetch(`/api/admin/users/${userId}/ban`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (!res.ok) throw new Error('ÙØ´Ù„ Ø§Ù„Ø­Ø¸Ø±');

                alert('ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
                loadUsers();
            } catch (e) {
                alert('Ø®Ø·Ø£: ' + e.message);
            }
        }

        // Delete user
        async function deleteUser(userId) {
            if (!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ\nØ³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡!')) return;

            try {
                const res = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (!res.ok) throw new Error('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');

                alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
                loadUsers();
            } catch (e) {
                alert('Ø®Ø·Ø£: ' + e.message);
            }
        }

        // ===== CHARTS =====
        let downloadsChart = null;
        let sourcesChart = null;

        async function loadCharts() {
            try {
                // Load weekly stats
                const weeklyRes = await fetch('/api/admin/stats/weekly', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                // Load general stats
                const statsRes = await fetch('/api/admin/stats', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                const weeklyData = weeklyRes.ok ? await weeklyRes.json() : { weeklyData: [] };
                const statsData = statsRes.ok ? await statsRes.json() : { sourceBreakdown: {} };

                // Create Downloads Line Chart
                const downloadsCtx = document.getElementById('downloadsChart');
                if (downloadsCtx) {
                    if (downloadsChart) downloadsChart.destroy();

                    const labels = weeklyData.weeklyData?.map(d => d.date) || ['Ø§Ù„ÙŠÙˆÙ…'];
                    const values = weeklyData.weeklyData?.map(d => d.count) || [0];

                    downloadsChart = new Chart(downloadsCtx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª',
                                data: values,
                                borderColor: '#1976d2',
                                backgroundColor: 'rgba(25, 118, 210, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }

                // Create Sources Pie Chart
                const sourcesCtx = document.getElementById('sourcesChart');
                if (sourcesCtx) {
                    if (sourcesChart) sourcesChart.destroy();

                    const sources = Object.entries(statsData.sourceBreakdown || {});
                    const sourceLabels = sources.map(([name]) => name) || ['YouTube', 'TikTok', 'Instagram'];
                    const sourceValues = sources.map(([, count]) => count) || [50, 30, 20];

                    sourcesChart = new Chart(sourcesCtx, {
                        type: 'doughnut',
                        data: {
                            labels: sourceLabels.length ? sourceLabels : ['YouTube', 'TikTok', 'Ø£Ø®Ø±Ù‰'],
                            datasets: [{
                                data: sourceValues.length ? sourceValues : [60, 25, 15],
                                backgroundColor: [
                                    '#ff0000',
                                    '#00f2ea',
                                    '#E1306C',
                                    '#1976d2',
                                    '#7c3aed'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    rtl: true
                                }
                            }
                        }
                    });
                }

            } catch (e) {
                console.error('Charts error:', e);
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            checkAdmin().then(() => {
                setTimeout(loadCharts, 500);
            });
        });
    </script>
</body>

</html>